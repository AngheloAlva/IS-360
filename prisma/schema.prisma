generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum USER_ROLE {
  SUPERADMIN
  ADMIN
  USER
  OPERATOR
  PARTNER_COMPANY
}

enum OTC_INTERNAL_ROLE {
  GENERAL_SUPERVISOR
  AREA_SUPERVISOR
  PREVENTION_OFFICER
  OPERATIONS_MANAGER
  MAINTENANCE_SUPERVISOR
  ENVIRONMENTAL_SUPERVISOR
  QUALITY_SUPERVISOR
  NONE
}

enum AREAS {
  OPERATIONS // Operaciones
  INSTRUCTIONS // Instructivos
  INTEGRITY_AND_MAINTENANCE // Integridad y Mantencion
  ENVIRONMENT // Medio Ambiente
  RISK_PREVENTION // Preveencion de Riesgos
  QUALITY_AND_PROFESSIONAL_EXCELLENCE // Calidad y Exelencia Profesional
  HSEQ // HSEQ (nueva)
  LEGAL // Juridica
  COMMUNITIES // Comunidades (periodistas?)
}

model User {
  id            String            @id
  name          String
  email         String
  emailVerified Boolean
  image         String?
  phone         String?
  createdAt     DateTime
  updatedAt     DateTime
  role          USER_ROLE         @default(PARTNER_COMPANY)
  internalRole  OTC_INTERNAL_ROLE @default(NONE)
  area          AREAS?
  banned        Boolean?
  banReason     String?
  banExpires    DateTime?
  rut           String

  sessions                       Session[]
  accounts                       Account[]
  files                          File[]
  folders                        Folder[]
  workTrackers                   WorkTracker[]
  safetyTalks                    UserSafetyTalk[]
  workApplications               WorkApplication[]
  company                        Company?            @relation(fields: [companyId], references: [id])
  companyId                      String?
  isSupervisor                   Boolean?
  workOrders                     WorkOrder[]         @relation("WorkOrderResponsible")
  workOrdersAsSupervisor         WorkOrder[]         @relation("WorkOrderSupervisor")
  assignedEntries                WorkEntry[]         @relation("AssignedUsers")
  reportedInEntries              WorkEntry[]         @relation("ReportedUsers")
  createdEntries                 WorkEntry[]         @relation("WorkEntryCreator")
  signedEntries                  WorkEntry[]         @relation("WorkEntrySigner")
  workEntries                    WorkEntry[]         @relation("WorkEntryApproval")
  workPermitsAsParticipant       WorkPermit[]        @relation("WorkPermitParticipants")
  workPermitsAsPreventionOfficer WorkPermit[]        @relation("PreventionOfficer")
  workPermits                    WorkPermit[]        @relation("WorkPermitUser")
  attachmentsHistory             AttachmentHistory[]
  equipmentHistory               EquipmentHistory[]

  @@unique([email])
  @@unique([rut])
  @@map("user")
}

model Session {
  id             String   @id
  expiresAt      DateTime
  token          String
  createdAt      DateTime
  updatedAt      DateTime
  ipAddress      String?
  userAgent      String?
  userId         String
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  impersonatedBy String?

  @@unique([token])
  @@map("session")
}

model Account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime
  updatedAt             DateTime

  @@map("account")
}

model Company {
  id String @id @default(cuid())

  name String
  rut  String

  users      User[]
  workOrders WorkOrder[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([id])
  @@map("company")
}

model Verification {
  id         String    @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime?
  updatedAt  DateTime?

  @@map("verification")
}

enum WORK_ORDER_STATUS {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
  EXPIRED
}

enum WORK_ORDER_TYPE {
  CORRECTIVE
  PREVENTIVE
  PREDICTIVE
}

enum WORK_ORDER_PRIORITY {
  HIGH
  MEDIUM
  LOW
}

model WorkOrder {
  id       String @id @default(cuid())
  otNumber String

  type             WORK_ORDER_TYPE
  status           WORK_ORDER_STATUS   @default(PENDING)
  solicitationDate DateTime
  solicitationTime String
  workRequest      String
  workDescription  String?
  priority         WORK_ORDER_PRIORITY
  equipment        Equipment[]
  programDate      DateTime
  estimatedHours   Float
  estimatedDays    Float
  requiresBreak    Boolean
  breakDays        Int?
  estimatedEndDate DateTime?
  isWorkBook       Boolean

  // Work book data
  workName           String?
  workLocation       String?
  workStartDate      DateTime?
  workProgressStatus Int?        @default(0)
  workEntries        WorkEntry[]

  company          Company            @relation(fields: [companyId], references: [id])
  companyId        String
  supervisor       User               @relation("WorkOrderSupervisor", fields: [supervisorId], references: [id])
  supervisorId     String
  responsible      User               @relation("WorkOrderResponsible", fields: [responsibleId], references: [id])
  responsibleId    String
  initReport       Attachment?        @relation("WorkOrderInitReport", fields: [initReportId], references: [id])
  initReportId     String?            @unique
  endReport        Attachment?        @relation("WorkOrderEndReport", fields: [endReportId], references: [id])
  endReportId      String?            @unique
  workPermits      WorkPermit[]
  workTrackers     WorkTracker[]
  equipmentHistory EquipmentHistory[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([id])
  @@unique([otNumber])
  @@map("work_order")
}

model Equipment {
  id      String @id @default(cuid())
  barcode String

  name          String
  description   String?
  location      String
  isOperational Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  workOrders WorkOrder[]
  history    EquipmentHistory[]

  @@unique([id])
  @@unique([barcode])
  @@map("equipment")
}

enum WORK_APPLICATION_STATUS {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
  EXPIRED
}

model WorkApplication {
  id String @id @default(cuid())

  description String
  location    String
  status      WORK_APPLICATION_STATUS @default(PENDING)
  criticality String

  attachments   Attachment[]
  responsible   User         @relation(fields: [responsibleId], references: [id])
  responsibleId String

  @@unique([id])
  @@map("work_application")
}

enum ENTRY_TYPE {
  DAILY_ACTIVITY
  ADDITIONAL_ACTIVITY
  PREVENTION_AREA
  OTC_INSPECTION
  COMMENT
  USER_NOTE
}

enum NOTE_STATUS {
  PENDING
  ACKNOWLEDGED
  RESOLVED
}

enum APPROVAL_STATUS {
  PENDING
  APPROVED
  REJECTED
}

model WorkEntry {
  id                String     @id @default(cuid())
  entryType         ENTRY_TYPE
  isFavorite        Boolean    @default(false)
  hasAttachments    Boolean    @default(false)
  executionDate     DateTime   @default(now())
  activityName      String?
  activityStartTime String?
  activityEndTime   String?
  comments          String?

  // Campos de OtcInspection
  supervisionComments String?
  safetyObservations  String?
  nonConformities     String?
  inspectorName       String?

  // Campos de PreventionArea
  recommendations String?
  others          String?
  preventionName  String?

  // Campos para notas de usuario
  noteStatus       NOTE_STATUS? @default(PENDING)
  notificationSent Boolean      @default(false)
  acknowledgedAt   DateTime?
  resolvedAt       DateTime?

  approvalStatus APPROVAL_STATUS? @default(PENDING)
  approvalDate   DateTime?
  approvalBy     User?            @relation("WorkEntryApproval", fields: [approvalById], references: [id])
  approvalById   String?

  createdAt   DateTime @default(now())
  createdBy   User     @relation("WorkEntryCreator", fields: [createdById], references: [id])
  createdById String

  // En caso de que sea un comentario, el usuario que lo firma
  signedAt   DateTime?
  signedBy   User?     @relation("WorkEntrySigner", fields: [signedById], references: [id])
  signedById String?

  workOrder   WorkOrder @relation(fields: [workOrderId], references: [id])
  workOrderId String

  // Relaciones con usuarios asignados y reportados
  assignedUsers User[] @relation(name: "AssignedUsers")
  reportedUsers User[] @relation(name: "ReportedUsers")

  // For comments/references to other entries
  referencedEntry   WorkEntry?         @relation("EntryReferences", fields: [referencedEntryId], references: [id])
  referencedEntryId String?
  referencedBy      WorkEntry[]        @relation("EntryReferences")
  equipmentHistory  EquipmentHistory[]

  attachments Attachment[]

  @@unique([id])
  @@index([workOrderId, createdAt]) // For efficient chronological listing
  @@map("work_book_entry")
}

model WorkTracker {
  id String @id @default(cuid())

  description     String
  date            DateTime
  dedicatedHours  Int
  quantityPersons Int
  location        String
  status          String

  user        User         @relation(fields: [userId], references: [id])
  userId      String
  attachments Attachment[]
  otNumber    WorkOrder    @relation(fields: [otNumberId], references: [id])
  otNumberId  String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("work_tracker")
}

model Attachment {
  id String @id @default(cuid())

  name String
  url  String
  type String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  workApplication   WorkApplication?    @relation(fields: [workApplicationId], references: [id])
  workApplicationId String?
  workEntry         WorkEntry?          @relation(fields: [workEntryId], references: [id])
  workEntryId       String?
  workTracker       WorkTracker?        @relation(fields: [workTrackerId], references: [id])
  workTrackerId     String?
  initReport        WorkOrder?          @relation("WorkOrderInitReport")
  initReportId      String?             @unique
  endReport         WorkOrder?          @relation("WorkOrderEndReport")
  endReportId       String?             @unique
  history           AttachmentHistory[]

  @@map("attachment")
}

enum WORK_PERMIT_STATUS {
  ACTIVE
  COMPLETED
  CANCELLED
  EXPIRED
}

model WorkPermit {
  id String @id @default(cuid())

  aplicantPt                     String
  responsiblePt                  String
  executanCompany                String
  mutuality                      String
  otherMutuality                 String?
  initDate                       DateTime
  endDate                        DateTime?
  hour                           String
  workersNumber                  Int
  workDescription                String
  exactPlace                     String
  workWillBe                     String
  workWillBeOther                String?
  tools                          String[]
  otherTools                     String?
  preChecks                      String[]
  otherPreChecks                 String?
  activityDetails                String[]
  riskIdentification             String[]
  otherRisk                      String?
  preventiveControlMeasures      String[]
  otherPreventiveControlMeasures String?
  generateWaste                  Boolean
  wasteType                      String?
  wasteDisposalLocation          String?
  whoDeliversWorkAreaOp          String
  workerExecutor                 String
  preventionOfficer              String
  preventionOfficerUser          User               @relation("PreventionOfficer", fields: [preventionOfficer], references: [id])
  whoReceives                    String?
  cleanAndTidyWorkArea           Boolean?
  workCompleted                  Boolean?
  observations                   String?
  additionalObservations         String?
  acceptTerms                    Boolean            @default(false)
  status                         WORK_PERMIT_STATUS @default(ACTIVE)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  otNumber     WorkOrder @relation(fields: [otNumberId], references: [id])
  otNumberId   String
  user         User      @relation("WorkPermitUser", fields: [userId], references: [id])
  userId       String
  participants User[]    @relation("WorkPermitParticipants")

  @@index([preventionOfficer])
  @@map("work_permit")
}

model Folder {
  id   String @id @default(cuid())
  slug String

  name        String
  description String?
  root        Boolean @default(false)
  area        AREAS
  type        String  @default("default")
  isExternal  Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  parent     Folder?  @relation("FolderToFolder", fields: [parentId], references: [id])
  parentId   String?
  subFolders Folder[] @relation("FolderToFolder")
  user       User     @relation(fields: [userId], references: [id])
  userId     String
  files      File[]

  @@unique([slug, parentId, userId])
  @@map("folder")
}

enum Code {
  INSTRUCTIVO
  FORMULARIO
  PROCEDIMIENTO
}

model File {
  id String @id @default(cuid())

  code             Code
  name             String
  description      String?
  type             String
  size             Int
  url              String
  registrationDate DateTime
  expirationDate   DateTime?
  revisionCount    Int       @default(0)
  isExternal       Boolean   @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  folder   Folder? @relation(fields: [folderId], references: [id])
  folderId String?
  user     User    @relation(fields: [userId], references: [id])
  userId   String

  @@map("file")
}

enum SAFETY_TALK_TYPE {
  IRL
  ENVIRONMENTAL
}

enum RESOURCE_TYPE {
  VIDEO
  PRESENTATION
  DOCUMENT
}

model SafetyTalk {
  id          String               @id @default(cuid())
  title       String
  description String?
  type        SAFETY_TALK_TYPE
  questions   Question[]
  resources   SafetyTalkResource[]
  expiresAt   DateTime
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt

  userSafetyTalks UserSafetyTalk[]

  @@map("safety_talk")
}

model SafetyTalkResource {
  id           String        @id @default(cuid())
  title        String
  description  String?
  type         RESOURCE_TYPE
  url          String
  downloadUrl  String?
  fileSize     Int?
  mimeType     String?
  order        Int
  safetyTalk   SafetyTalk    @relation(fields: [safetyTalkId], references: [id])
  safetyTalkId String
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  @@map("safety_talk_resource")
}

model Question {
  id           String           @id @default(cuid())
  question     String
  options      QuestionOption[]
  safetyTalk   SafetyTalk       @relation(fields: [safetyTalkId], references: [id])
  safetyTalkId String
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt

  userAnswers UserSafetyTalkAnswer[]

  @@map("question")
}

model QuestionOption {
  id         String   @id @default(cuid())
  text       String
  isCorrect  Boolean
  question   Question @relation(fields: [questionId], references: [id])
  questionId String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  userAnswers UserSafetyTalkAnswer[]

  @@map("question_option")
}

model UserSafetyTalk {
  id           String                 @id @default(cuid())
  user         User                   @relation(fields: [userId], references: [id])
  userId       String
  safetyTalk   SafetyTalk             @relation(fields: [safetyTalkId], references: [id])
  safetyTalkId String
  score        Float
  passed       Boolean
  completedAt  DateTime
  expiresAt    DateTime
  answers      UserSafetyTalkAnswer[]
  createdAt    DateTime               @default(now())
  updatedAt    DateTime               @updatedAt

  @@map("user_safety_talk")
}

model UserSafetyTalkAnswer {
  id               String         @id @default(cuid())
  userSafetyTalk   UserSafetyTalk @relation(fields: [userSafetyTalkId], references: [id])
  userSafetyTalkId String
  question         Question       @relation(fields: [questionId], references: [id])
  questionId       String
  selectedOption   QuestionOption @relation(fields: [selectedOptionId], references: [id])
  selectedOptionId String
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt

  @@map("user_safety_talk_answer")
}

model AttachmentHistory {
  id           String     @id @default(cuid())
  attachment   Attachment @relation(fields: [attachmentId], references: [id])
  attachmentId String
  previousUrl  String
  previousName String
  modifiedBy   User       @relation(fields: [userId], references: [id])
  userId       String
  modifiedAt   DateTime   @default(now())
  reason       String?

  @@map("attachment_history")
}

model EquipmentHistory {
  id          String     @id @default(cuid())
  equipment   Equipment  @relation(fields: [equipmentId], references: [id])
  equipmentId String
  changeType  String
  description String
  modifiedBy  User       @relation(fields: [userId], references: [id])
  userId      String
  modifiedAt  DateTime   @default(now())
  status      String
  createdAt   DateTime   @default(now())
  workOrder   WorkOrder? @relation(fields: [workOrderId], references: [id])
  workOrderId String?
  workEntry   WorkEntry? @relation(fields: [workEntryId], references: [id])
  workEntryId String?

  @@unique([id])
  @@map("equipment_history")
}
