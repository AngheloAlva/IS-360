
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum USER_ROLE {
  SUPERADMIN
  ADMIN
  USER
  PARTNER_COMPANY
}

enum OTC_INTERNAL_ROLE {
  GENERAL_SUPERVISOR
  AREA_SUPERVISOR
  PREVENTION_OFFICER
  OPERATIONS_MANAGER
  MAINTENANCE_SUPERVISOR
  ENVIRONMENTAL_SUPERVISOR
  QUALITY_SUPERVISOR
  NONE
}

enum AREAS {
  OPERATIONS // Operaciones
  INSTRUCTIONS // Instructivos
  INTEGRITY_AND_MAINTENANCE // Integridad y Mantencion
  ENVIRONMENT // Medio Ambiente
  RISK_PREVENTION // Preveencion de Riesgos
  QUALITY_AND_PROFESSIONAL_EXCELLENCE // Calidad y Exelencia Profesional
  HSEQ // HSEQ (nueva)
  LEGAL // Juridica
  COMMUNITIES // Comunidades (periodistas?)
}

model User {
  id            String    @id
  name          String
  email         String
  emailVerified Boolean
  image         String?
  createdAt     DateTime
  updatedAt     DateTime
  role          USER_ROLE @default(PARTNER_COMPANY)
  internalRole  OTC_INTERNAL_ROLE @default(NONE)
  area          AREAS?
  banned        Boolean?
  banReason     String?
  banExpires    DateTime?
  rut           String

  sessions      Session[]
  accounts      Account[]
  workBooks     WorkBook[]
  workTrackers  WorkTracker[]
  workPermits   WorkPermit[]
  folders       Folder[]
  files         File[]
  workOrders    WorkOrder[]
  safetyTalks   UserSafetyTalk[]
  workPermitsAsPreventionOfficer WorkPermit[] @relation("PreventionOfficer")

  @@unique([email])
  @@unique([rut])
  @@map("user")
}

model Session {
  id             String   @id
  expiresAt      DateTime
  token          String
  createdAt      DateTime
  updatedAt      DateTime
  ipAddress      String?
  userAgent      String?
  userId         String
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  impersonatedBy String?

  @@unique([token])
  @@map("session")
}

model Account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime
  updatedAt             DateTime

  @@map("account")
}

model Verification {
  id         String    @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime?
  updatedAt  DateTime?

  @@map("verification")
}

enum WORK_ORDER_STATUS {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
  EXPIRED
}

model WorkOrder {
  id                 String  @id @default(cuid())
  otNumber           String

  initDate           DateTime
  endDate            DateTime
  quantityDays       Int
  equipmentProperty  String
  status             WORK_ORDER_STATUS @default(PENDING)
  estimatedDuration  Int
  printed            Boolean
  type               String
  contractCompany    String
  
  responsible        User @relation(fields: [responsibleId], references: [id])
  responsibleId      String
  workBooks          WorkBook[]
  workTrackers       WorkTracker[]
  workPermits        WorkPermit[]

  @@unique([id])
  @@unique([otNumber])
  @@map("work_order")
}

model WorkBook {
  id                   String  @id @default(cuid())

  contractingCompany   String
  workResponsibleName  String
  workResponsiblePhone String
  otcInspectorName     String
  otcInspectorPhone    String
  workName             String
  workLocation         String
  workType             String
  workStartDate        DateTime
  workEstimatedEndDate DateTime
  workStatus           String
  workProgressStatus   String

  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  otNumber             WorkOrder @relation(fields: [otNumberId], references: [id])
  otNumberId           String
  user                 User @relation(fields: [userId], references: [id])
  userId               String
  dailyActivities      DailyActivity[]
  aditionalActivities  AditionalActivity[]
  otcInspections       OtcInspection[]
  preventionAreas      PreventionArea[]

  @@unique([id])
  @@map("work_book")
}

model DailyActivity {
  id                 String  @id @default(cuid())

  comments           String?
  executionDate      DateTime
  activityStartTime  String
  activityEndTime    String
  activityName       String

  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  workBook           WorkBook @relation(fields: [workBookId], references: [id])
  workBookId         String
  personnel          Personnel[]
  attachments        Attachment[]

  @@unique([id])
  @@map("daily_activity")
}

model Personnel {
  id                 String  @id @default(cuid())

  fullName           String
  position           String?
  rut                String?
  phone              String?
  email              String?
  number             Int?
  company            String?


  dailyActivity      DailyActivity? @relation(fields: [dailyActivityId], references: [id])
  dailyActivityId    String?
  workPermit         WorkPermit? @relation(fields: [workPermitId], references: [id])
  workPermitId       String?

  @@unique([id])
  @@map("personnel")
}

model AditionalActivity {
  id                 String  @id @default(cuid())

  comments           String?
  executionDate      DateTime
  activityStartTime  String 
  activityEndTime    String
  activityName       String

  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  workBook           WorkBook @relation(fields: [workBookId], references: [id])
  workBookId         String
  attachments        Attachment[]

  @@unique([id])
  @@map("aditional_activity")
}

model OtcInspection {
  id                  String  @id @default(cuid())

  inspectorName       String
  dateOfExecution     DateTime
  activityStartTime   String
  activityEndTime     String
  supervisionComments String
  safetyObservations  String
  nonConformities     String?
  initialDate         DateTime

  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  workBook            WorkBook @relation(fields: [workBookId], references: [id])
  workBookId          String
  attachments         Attachment[]

  @@unique([id])
  @@map("otc_inspection")
}

model PreventionArea {
  id                 String  @id @default(cuid())

  name               String
  recommendations    String?
  others             String?
  comments           String?
  initialDate        DateTime
  initialTime        String

  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  workBook           WorkBook @relation(fields: [workBookId], references: [id])
  workBookId         String

  @@unique([id])
  @@map("prevention_area")
}

model WorkTracker {
  id                 String  @id @default(cuid())

  description        String
  date               DateTime
  dedicatedHours     Int
  quantityPersons    Int
  location           String
  status             String

  user               User @relation(fields: [userId], references: [id])
  userId             String
  attachments        Attachment[]
  otNumber             WorkOrder @relation(fields: [otNumberId], references: [id])
  otNumberId           String

  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@map("work_tracker")
}

model Attachment {
  id                  String  @id @default(cuid())

  name                String
  url                 String
  type                String

  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  aditionalActivity   AditionalActivity @relation(fields: [aditionalActivityId], references: [id])
  aditionalActivityId String
  dailyActivity       DailyActivity     @relation(fields: [dailyActivityId], references: [id])
  dailyActivityId     String
  otcInspection       OtcInspection     @relation(fields: [otcInspectionId], references: [id])
  otcInspectionId     String
  workTracker         WorkTracker       @relation(fields: [workTrackerId], references: [id])
  workTrackerId       String

  @@map("attachment")
}

enum WORK_PERMIT_STATUS {
  ACTIVE
  COMPLETED
  CANCELLED
  EXPIRED
}

// enum MAINTENANCE_LOCATION_TYPE {
//   TRM // Terminal Recepción Marítimo
//   PRS // Planta Reguladora de Presión
//   SDV // Válvula de Seccionamiento
//   PIPELINE_16 // Ducto 16"
//   PIPELINE_30 // Ducto 30"
// }

// model MaintenanceLocation {
//   id          String @id @default(cuid())
//   name        String
//   type        MAINTENANCE_LOCATION_TYPE
//   code        String // Ejemplo: "SDV-11", "SDV-12", etc.
//   description String?
//   active      Boolean @default(true)
  
//   // Para ductos, relacionar los puntos de inicio y fin
//   startPoint  MaintenanceLocation? @relation("PipelineStartPoints", fields: [startPointId], references: [id])
//   startPointId String?
//   endPoint    MaintenanceLocation? @relation("PipelineEndPoints", fields: [endPointId], references: [id])
//   endPointId  String?
  
//   // Relaciones inversas para ductos
//   pipelinesAsStart MaintenanceLocation[] @relation("PipelineStartPoints")
//   pipelinesAsEnd   MaintenanceLocation[] @relation("PipelineEndPoints")
  
//   // Relación con WorkPermit
//   workPermits WorkPermit[]
  
//   // Relación con equipos
//   equipments MaintenanceEquipment[]
  
//   createdAt DateTime @default(now())
//   updatedAt DateTime @updatedAt
  
//   @@unique([type, code])
//   @@map("maintenance_location")
// }

// model MaintenanceEquipment {
//   id          String @id @default(cuid())
//   name        String
//   code        String // Código SAP/MP10
//   description String?
//   type        String // Tipo de equipo
//   status      String // Estado del equipo
//   active      Boolean @default(true)
  
//   // Relación con ubicación
//   location    MaintenanceLocation @relation(fields: [locationId], references: [id])
//   locationId  String
  
//   // Relación con WorkPermit
//   workPermits WorkPermit[]
  
//   createdAt   DateTime @default(now())
//   updatedAt   DateTime @updatedAt
  
//   @@unique([code])
//   @@map("maintenance_equipment")
// }

model WorkPermit {
  id                             String @id @default(cuid())

  aplicantPt                     String
  responsiblePt                  String
  executanCompany                String
  mutuality                      String
  otherMutuality                 String?
  initDate                       DateTime
  endDate                        DateTime?
  hour                           String
  workersNumber                  Int
  workDescription                String
  exactPlace                     String
  workWillBe                     String
  workWillBeOther                String?
  tools                          String[]
  otherTools                     String?
  preChecks                      String[]
  otherPreChecks                 String?
  activityDetails                String[]
  riskIdentification             String[]
  otherRisk                      String?
  preventiveControlMeasures      String[]
  otherPreventiveControlMeasures String?
  generateWaste                  Boolean
  wasteType                      String?
  wasteDisposalLocation          String?
  whoDeliversWorkAreaOp          String
  workerExecutor                 String
  preventionOfficer              String    @map("prevention_officer_id")
  preventionOfficerUser          User      @relation("PreventionOfficer", fields: [preventionOfficer], references: [id])
  whoReceives                    String?
  cleanAndTidyWorkArea           Boolean?
  workCompleted                  Boolean?
  observations                   String?
  additionalObservations         String?
  acceptTerms                    Boolean  @default(false)
  status                         WORK_PERMIT_STATUS @default(ACTIVE)

  // Nuevas relaciones para ubicación y equipos
  // location                       MaintenanceLocation @relation(fields: [locationId], references: [id])
  // locationId                     String
  // equipment                      MaintenanceEquipment? @relation(fields: [equipmentId], references: [id])
  // equipmentId                    String?

  createdAt                      DateTime @default(now())
  updatedAt                      DateTime @updatedAt

  otNumber                       WorkOrder @relation(fields: [otNumberId], references: [id])
  otNumberId                     String
  user                           User     @relation(fields: [userId], references: [id])
  userId                         String
  participants                   Personnel[]

  @@map("work_permit")
  @@index([preventionOfficer])
  // @@index([locationId])
  // @@index([equipmentId])
}

enum Area {
  OPERACIONES
  INSTRUCTIVOS
  INTEGRIDAD_Y_MANTENCION
  MEDIO_AMBIENTE
  PREVENCION_RIESGOS
  CALIDAD_Y_EXCELENCIA_PROFESIONAL
  HSEQ
  JURIDICA
  COMUNIDADES
}

model Folder {
  id          String  @id @default(cuid())
  slug        String

  name        String
  description String?
  root        Boolean  @default(false)
  area        Area
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  parent      Folder?  @relation("FolderToFolder", fields: [parentId], references: [id])
  parentId    String? 
  subFolders  Folder[] @relation("FolderToFolder")
  user        User     @relation(fields: [userId], references: [id])
  userId      String
  files       File[]

  @@unique([slug, parentId, userId])
  @@map("folder")
}

enum Code {
  INSTRUCTIVO
  FORMULARIO
  PROCEDIMIENTO
}

model File {
  id               String   @id @default(cuid())

  code             Code
  name             String
  description      String?
  type             String
  size             Int
  url              String
  registrationDate DateTime
  expirationDate   DateTime?
  revisionCount    Int      @default(0)

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  folder           Folder?  @relation(fields: [folderId], references: [id])
  folderId         String?
  user             User     @relation(fields: [userId], references: [id])
  userId           String

  @@map("file")
}

enum SAFETY_TALK_TYPE {
  IRL
  ENVIRONMENTAL
}

enum RESOURCE_TYPE {
  VIDEO
  PRESENTATION
  DOCUMENT
}

model SafetyTalk {
  id          String   @id @default(cuid())
  title       String
  description String?
  type        SAFETY_TALK_TYPE
  questions   Question[]
  resources   SafetyTalkResource[]
  expiresAt   DateTime
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  userSafetyTalks UserSafetyTalk[]

  @@map("safety_talk")
}

model SafetyTalkResource {
  id          String   @id @default(cuid())
  title       String
  description String?
  type        RESOURCE_TYPE
  url         String
  downloadUrl String?
  fileSize    Int?
  mimeType    String?
  order       Int
  safetyTalk  SafetyTalk @relation(fields: [safetyTalkId], references: [id])
  safetyTalkId String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("safety_talk_resource")
}


model Question {
  id            String   @id @default(cuid())
  question      String
  options       QuestionOption[]
  safetyTalk    SafetyTalk @relation(fields: [safetyTalkId], references: [id])
  safetyTalkId  String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  userAnswers   UserSafetyTalkAnswer[]

  @@map("question")
}

model QuestionOption {
  id          String   @id @default(cuid())
  text        String
  isCorrect   Boolean
  question    Question @relation(fields: [questionId], references: [id])
  questionId  String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  userAnswers UserSafetyTalkAnswer[]

  @@map("question_option")
}

model UserSafetyTalk {
  id            String   @id @default(cuid())
  user          User     @relation(fields: [userId], references: [id])
  userId        String
  safetyTalk    SafetyTalk @relation(fields: [safetyTalkId], references: [id])
  safetyTalkId  String
  score         Float
  passed        Boolean
  completedAt   DateTime
  expiresAt     DateTime
  answers       UserSafetyTalkAnswer[]
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("user_safety_talk")
}

model UserSafetyTalkAnswer {
  id                String   @id @default(cuid())
  userSafetyTalk    UserSafetyTalk @relation(fields: [userSafetyTalkId], references: [id])
  userSafetyTalkId  String
  question          Question @relation(fields: [questionId], references: [id])
  questionId        String
  selectedOption    QuestionOption @relation(fields: [selectedOptionId], references: [id])
  selectedOptionId  String
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@map("user_safety_talk_answer")
}

